<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Source &mdash; PyActor 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="PyActor 0.1 documentation" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">PyActor 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="source">
<span id="id1"></span><h1>Source<a class="headerlink" href="#source" title="Permalink to this headline">¶</a></h1>
<div class="section" id="actor">
<span id="actor-source"></span><h2>Actor<a class="headerlink" href="#actor" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Queue</span> <span class="k">import</span> <span class="n">Queue</span><span class="p">,</span><span class="n">Empty</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">util</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>


<span class="k">class</span> <span class="nc">Channel</span><span class="p">(</span><span class="n">Queue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Channel is the main communication mechanism between actors. It is actually a</span>
<span class="sd">    simple facade to the Queue.Queue python class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Queue</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It sends a message to the current channel.</span>

<span class="sd">        :param msg: The message sent to an actor. It is a tuple using the constants</span>
<span class="sd">            in util.py (:mod:`pyactor.util`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It receives a message from the channel, blocking the calling thread until</span>
<span class="sd">        the response is received, or the timeout is triggered.</span>

<span class="sd">        :param int timeout: timeout to wait for messages. If none provided it will</span>
<span class="sd">            block until a message arrives.</span>
<span class="sd">        :return: returns a message sent to the channel. It is a tuple using the</span>
<span class="sd">            constants in util.py (:mod:`pyactor.util`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ActorRef</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ActorRef contains the main components of an actor. These are the URL where it</span>
<span class="sd">    is located, the communication :class:`~.Channel` and the class of the actor</span>
<span class="sd">    as also the synchronous and asynchronous methods the class implements.</span>
<span class="sd">    When no channel is specified a new one will be created wich is also the</span>
<span class="sd">    default procedure.</span>

<span class="sd">    .. note:: This is a superclass of :py:class:`Actor` and has no direct functionality.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">url</span><span class="p">,</span><span class="n">klass</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tell</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ask</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">channel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="s1">&#39;_tell&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">klass</span><span class="o">.</span><span class="n">_tell</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tell</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">_tell</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="s1">&#39;_ask&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">klass</span><span class="o">.</span><span class="n">_ask</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ask</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">_ask</span><span class="p">)</span>


        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="s1">&#39;_ref&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tell_ref</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">_ref</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ask_ref</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">_ref</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_ref</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tell_ref</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tell</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ask_ref</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tell_ref</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">klass</span> <span class="o">=</span> <span class="n">klass</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Actor(url=</span><span class="si">%s</span><span class="s1">, class=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Actor</span><span class="p">(</span><span class="n">ActorRef</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Actor is the instance of an object to which is possible to acces and invoke</span>
<span class="sd">    its methods remotely. Main element of the model. The host is the one to create</span>
<span class="sd">    them (spawning -&gt; see :meth:`~.spawn`).</span>

<span class="sd">    :param str. url: URL where the actor is running.</span>
<span class="sd">    :param class klass: class type for the actor.</span>
<span class="sd">    :param klass obj: instance of the *klass* class to attach to the actor.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Actor</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">klass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tell</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">__processQueue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :return: (*bool.*) identifies the current state of the actor. **True** if</span>
<span class="sd">            it is running.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span>

    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The message received from the queue specify a method of the class the</span>
<span class="sd">        actor represents. This invokes it. If the communication is an</span>
<span class="sd">        :class:`~.AskRequest`, sends the result back to the channel included in</span>
<span class="sd">        the message as an :class:`~.AskResponse`.</span>
<span class="sd">        If it is a :class:`~.Future`, generates a :class:`~.TellRequest` to send</span>
<span class="sd">        the result to the sender&#39;s method specified in the callback field of the</span>
<span class="sd">        tuple.</span>

<span class="sd">        :param msg: The message is a namedtuple of the defined in util.py</span>
<span class="sd">            (:class:`~.AskRequest`, :class:`~.TellRequest`, :class:`~.FutureRequest`).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">method</span><span class="o">==</span><span class="s1">&#39;stop&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">invoke</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">params</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">invoke</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">e</span>
                <span class="nb">print</span> <span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ASK</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">AskResponse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FUTURE</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">TellRequest</span><span class="p">(</span><span class="n">TELL</span><span class="p">,</span><span class="n">msg</span><span class="o">.</span><span class="n">callback</span><span class="p">,[</span><span class="n">result</span><span class="p">],</span><span class="n">msg</span><span class="o">.</span><span class="n">from_url</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates the actor thread wich will process the channel queue while the</span>
<span class="sd">        actor :meth:`is_alive`, making it able to receive queries.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__processQueue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="proxy">
<span id="proxy-source"></span><h2>Proxy<a class="headerlink" href="#proxy" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">actor</span> <span class="k">import</span> <span class="n">Channel</span>
<span class="kn">from</span> <span class="nn">parallels</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">util</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">Queue</span> <span class="k">import</span> <span class="n">Empty</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>

<span class="k">class</span> <span class="nc">Proxy</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Proxy is the class that supports to create a remote reference to an actor</span>
<span class="sd">    and invoke its methods.</span>

<span class="sd">    :param Actor actor: the actor the proxy will manage.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__channel</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="o">=</span> <span class="n">actor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span> <span class="o">=</span> <span class="n">get_lock</span><span class="p">()</span>
        <span class="c1"># print &quot;At proxy&quot;,self.__lock#, self.actor</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">actor</span><span class="o">.</span><span class="n">ask_ref</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">AskRefWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__channel</span><span class="p">,</span><span class="n">method</span><span class="p">,</span><span class="n">actor</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">actor</span><span class="o">.</span><span class="n">tell_ref</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">TellRefWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__channel</span><span class="p">,</span><span class="n">method</span><span class="p">,</span><span class="n">actor</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">actor</span><span class="o">.</span><span class="n">tell</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">TellWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__channel</span><span class="p">,</span><span class="n">method</span><span class="p">,</span><span class="n">actor</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">actor</span><span class="o">.</span><span class="n">ask</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">AskWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__channel</span><span class="p">,</span><span class="n">method</span><span class="p">,</span><span class="n">actor</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Proxy(actor=</span><span class="si">%s</span><span class="s1">, tell=</span><span class="si">%s</span><span class="s1"> ref=</span><span class="si">%s</span><span class="s1">, ask=</span><span class="si">%s</span><span class="s1"> ref=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">tell</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">tell_ref</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ask_ref</span><span class="p">)</span>




<span class="k">class</span> <span class="nc">Future</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Future manages the remote method invocations that returns a result.</span>
<span class="sd">    Mostly for ask requests.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">actor_channel</span><span class="p">,</span><span class="n">method</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">actor_url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__actor_channel</span> <span class="o">=</span> <span class="n">actor_channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__target</span> <span class="o">=</span> <span class="n">actor_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span> <span class="o">=</span> <span class="n">get_lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;Future&#39; object has no attribute </span><span class="si">%r</span><span class="s2">. Remember to call get() after an ask query.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Invokes the method sending a query through the channel and obtains the</span>
<span class="sd">        result of this method.</span>

<span class="sd">        It is necessary to invoke this method with a synchronous query in order</span>
<span class="sd">        to get the result. As in :ref:`sample2`::</span>

<span class="sd">            e1.say_something().get()</span>

<span class="sd">        Unless you use this method, you will get the future itself, which means</span>
<span class="sd">        the method has not been invoked yet, like in :ref:`sample3`::</span>

<span class="sd">            future = self.echo.say_something()</span>

<span class="sd">        In this case, you could set a callback with :meth:`add_callback`, so the</span>
<span class="sd">        result will be sent to the method you specify.</span>

<span class="sd">        :param int timeout: timeout to wait for the result. If not specified,</span>
<span class="sd">            it&#39;s set to 1 sec.</span>
<span class="sd">        :returns: the result of the invoked method. Could be any type.</span>
<span class="sd">        :raises: :class:`Timeout`, or an error receiving from the channel.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">##  SENDING MESSAGE ASK</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">AskRequest</span><span class="p">(</span><span class="n">ASK</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__method</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__params</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__channel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__actor_channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="p">:</span>
            <span class="c1"># print &quot;At get, release&quot;,self.__lock, self.__method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__channel</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">result</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="n">AlreadyExists</span><span class="p">,</span> <span class="n">ae</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ae</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Timeout</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">callback</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Sets a callback on the Future. This will generate a new</span>
<span class="sd">        :class:`~.FutureRequest` sent to the actor that will invoke</span>
<span class="sd">        the callback function with the result by parameter.</span>

<span class="sd">        In :ref:`sample3` you can see how to use it::</span>

<span class="sd">            future = self.echo.say_something()</span>
<span class="sd">            future.add_callback(&#39;pong&#39;)</span>

<span class="sd">        pong is a method of the same class that receives the result of the query</span>
<span class="sd">        in parameter *msg*::</span>

<span class="sd">            def pong(self,msg):</span>
<span class="sd">                print &#39;callback&#39;,msg</span>

<span class="sd">        :param str. callback: name of the function where to send the response.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">from_actor</span> <span class="o">=</span> <span class="n">get_current</span><span class="p">()</span>
        <span class="c1">##  SENDING MESSAGE FUTURE</span>
        <span class="c1">#msg = (_from, self.target, FUTURE, self.method,self.params,callback,actors[_from].channel)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">FutureRequest</span><span class="p">(</span><span class="n">FUTURE</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__method</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__params</span><span class="p">,</span><span class="n">callback</span><span class="p">,</span>
                                <span class="n">from_actor</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__target</span><span class="p">,</span><span class="n">from_actor</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__actor_channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">FutureRef</span><span class="p">(</span><span class="n">Future</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FutureRef</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_host</span><span class="p">()</span><span class="o">.</span><span class="n">_loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TellWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Wrapper for Tell type queries to the proxy. Creates the request and sends it</span>
<span class="sd">    through the channel.</span>

<span class="sd">    :param Channel channel: communication way for the query.</span>
<span class="sd">    :param str. method: name of the method this query is gonna invoke.</span>
<span class="sd">    :param str. actor_url: URL address where the actor is set.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">actor_url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__target</span> <span class="o">=</span> <span class="n">actor_url</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1">#_from = get_current()</span>
        <span class="c1">##  SENDING MESSAGE TELL</span>
        <span class="c1">#msg = (_from, self.__target, TELL, self.__method,args)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">TellRequest</span><span class="p">(</span><span class="n">TELL</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__method</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AskWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Wrapper for Ask type queries to the proxy. Creates a :class:`Future` to</span>
<span class="sd">    manage the result reply.</span>

<span class="sd">    :param Channel channel: communication way for the query.</span>
<span class="sd">    :param str. method: name of the method this query is gonna invoke.</span>
<span class="sd">    :param str. actor_url: URL address where the actor is set.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span><span class="n">actor_url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">actor_url</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">,</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AskRefWrapper</span><span class="p">(</span><span class="n">AskWrapper</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Wrapper for Ask queries that have a proxy in parameters or returns.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">new_args</span> <span class="o">=</span> <span class="n">get_host</span><span class="p">()</span><span class="o">.</span><span class="n">_dumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">FutureRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">,</span><span class="n">new_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TellRefWrapper</span><span class="p">(</span><span class="n">TellWrapper</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Wrapper for Tell queries that have a proxy in parameters.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">new_args</span> <span class="o">=</span> <span class="n">get_host</span><span class="p">()</span><span class="o">.</span><span class="n">_dumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TellRefWrapper</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">new_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="context">
<span id="context-source"></span><h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">urlparse</span> <span class="k">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">actor</span> <span class="k">import</span> <span class="n">Actor</span><span class="p">,</span><span class="n">ActorRef</span>
<span class="kn">from</span> <span class="nn">parallels</span> <span class="k">import</span> <span class="n">ActorParallel</span>
<span class="kn">from</span> <span class="nn">proxy</span> <span class="k">import</span> <span class="n">Proxy</span>
<span class="kn">from</span> <span class="nn">util</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">signal</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">create_host</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;local://local:6666/host&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is the main function to create a new Host to which you can spawn actors.</span>
<span class="sd">    It will be set by default at local address if no parameter *url* is given.</span>
<span class="sd">    This function shuould be called once for execution or after callig</span>
<span class="sd">    :meth:`~.shutdown` to the previous host. Only one host can be alive at a time,</span>
<span class="sd">    trying to create more than one will raise an exception.</span>

<span class="sd">    :param str. url: URL where to start and bind the host.</span>
<span class="sd">    :return: :class:`~.Host` created.</span>
<span class="sd">    :rise: Exception if there is a host already created.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">host</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Host already created. Only one host can be ran at a time.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">util</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">Host</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">host</span>

<span class="k">class</span> <span class="nc">Host</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Host must be created using the function :func:`~create_host`.</span>

<span class="sd">    Host is the container of the actors. It manages the spawn and elimination of</span>
<span class="sd">    actors and their communication through channels. Also configures the TCP socket</span>
<span class="sd">    where the actors will be able to receive queries remotely.</span>
<span class="sd">    Additionaly, controls the correct management of the threads and intervals of</span>
<span class="sd">    its actors.</span>

<span class="sd">    The host can be managed as a simple object, but it also is an actor itself so</span>
<span class="sd">    you can get its :class:`~.Proxy` (with ``host.proxy``) and pass it to another</span>
<span class="sd">    host to spawn remotely.</span>

<span class="sd">    :param str. url: URL that identifies the host.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_tell</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;attach_interval&#39;</span><span class="p">,</span><span class="s1">&#39;detach_interval&#39;</span><span class="p">]</span>
    <span class="n">_ask</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spawn&#39;</span><span class="p">,</span><span class="s1">&#39;lookup&#39;</span><span class="p">,</span><span class="s1">&#39;spawn_n&#39;</span><span class="p">,</span><span class="s1">&#39;lookup_url&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pthreads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intervals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alive</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_transport</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_transport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        ### Not yet functional</span>
<span class="sd">        For TCP communication. Sets the communication socket of the host at the</span>
<span class="sd">        address and port specified.</span>

<span class="sd">        :param str. url: URL where to bind the host. Must be provided in the</span>
<span class="sd">            tipical format: &#39;scheme://address:port/hierarchical_path&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">aurl</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">addrl</span> <span class="o">=</span> <span class="n">aurl</span><span class="o">.</span><span class="n">netloc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addrl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">addrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">aurl</span><span class="o">.</span><span class="n">scheme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host_url</span> <span class="o">=</span> <span class="n">aurl</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if aurl.scheme == &#39;tcp&#39;:</span>
<span class="sd">            self.tcp = Server(self.addr)</span>
<span class="sd">            dispatcher = self.tcp.get_dispatcher(self.addr)</span>
<span class="sd">            launch_actor(self.addr,dispatcher)&#39;&#39;&#39;</span>

            <span class="c1">#self.aref = &#39;atom://&#39; + self.dispatcher.name + &#39;/controller/Host/0&#39;</span>
            <span class="c1">#self.name = self.dispatcher.name</span>

    <span class="k">def</span> <span class="nf">spawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">klass</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This method creates an actor attached to this host. It will be an</span>
<span class="sd">        instance of the class *klass* and it will be assigned an ID that identifies</span>
<span class="sd">        it among the host.</span>

<span class="sd">        This method can be called remotely synchronously.</span>

<span class="sd">        :param str. id: identifier for the spawning actor. Unique within the host.</span>
<span class="sd">        :param class klass: class type of the spawning actor.</span>
<span class="sd">        :param list args: arguments for the init function of the spawning actor class.</span>
<span class="sd">        :return: :class:`~.Proxy` of the actor spawned.</span>
<span class="sd">        :raises: :class:`AlreadyExists`, if the ID specified is already in use.</span>
<span class="sd">        :raises: :class:`HostDown` if there is no host initiated.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HostDown</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">host_url</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">AlreadyExists</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span>
            <span class="c1"># else:</span>
            <span class="c1">#     obj.host = Exception(&quot;Host is not an active actor. Use &#39;init_host&#39; to make it alive.&quot;)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="s1">&#39;_parallel&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">klass</span><span class="o">.</span><span class="n">_parallel</span><span class="p">:</span>
                <span class="n">new_actor</span> <span class="o">=</span> <span class="n">ActorParallel</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">klass</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">lock</span> <span class="o">=</span> <span class="n">new_actor</span><span class="o">.</span><span class="n">get_lock</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">lock</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_actor</span> <span class="o">=</span> <span class="n">Actor</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">klass</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>

            <span class="n">obj</span><span class="o">.</span><span class="n">proxy</span> <span class="o">=</span> <span class="n">Proxy</span><span class="p">(</span><span class="n">new_actor</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">launch_actor</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">new_actor</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Proxy</span><span class="p">(</span><span class="n">new_actor</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets a new proxy that references to the actor of this host identified by</span>
<span class="sd">        the given ID.</span>

<span class="sd">        This method can be called remotely synchronously.</span>

<span class="sd">        :param str. id: identifier of the actor you want.</span>
<span class="sd">        :return: :class:`~.Proxy` of the actor requiered.</span>
<span class="sd">        :raises: :class:`HostDown`  if the host is down.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HostDown</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span>  <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">host_url</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Proxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">url</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFound</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Stops the Host, stopping at the same time all its actors.</span>
<span class="sd">        Should be called at the end of its usage, to finish correctly all the</span>
<span class="sd">        connections and threads.</span>
<span class="sd">        When the actors stop running, they can&#39;t be started again and the host</span>
<span class="sd">        can&#39;t process new spawns. You might need to create a new host</span>
<span class="sd">        (:func:`create_host`).</span>

<span class="sd">        This method can&#39;t be called remotely.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">Proxy</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="n">actor</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">interval_event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intervals</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">interval_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pthreads</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">util</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>



    <span class="k">def</span> <span class="nf">lookup_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets a proxy reference to the actor indicated by the URL in the parameters.</span>
<span class="sd">        It can be a local reference or a TCP direction.</span>

<span class="sd">        This method can be called remotely synchronously.</span>

<span class="sd">        :param srt. url: address that identifies an actor.</span>
<span class="sd">        :return: :class:`~.Proxy` of the actor requested.</span>
<span class="sd">        :raise: :class:`NotFound`, if the URL specified do not correspond to any</span>
<span class="sd">            actor in the host.</span>
<span class="sd">        :raises: :class:`HostDown`  if the host is down.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HostDown</span><span class="p">()</span>
        <span class="n">aurl</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">aurl</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">NotFound</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Proxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">url</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;TCPthing&quot;</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;addrl = aurl.netloc.split(&#39;:&#39;)</span>
<span class="sd">            addr = addrl[0],addrl[1]</span>
<span class="sd">            if actors.has_key(addr):</span>
<span class="sd">                dispatcher = actors[addr]</span>
<span class="sd">            else:</span>
<span class="sd">                dispatcher = self.tcp.get_dispatcher(addr)</span>
<span class="sd">                launch_actor(addr,dispatcher)</span>
<span class="sd">            remote_actor = ActorRef(url,klass,dispatcher.channel)</span>
<span class="sd">            return Proxy(remote_actor)&#39;&#39;&#39;</span>


    <span class="k">def</span> <span class="nf">is_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aurl</span><span class="p">):</span>
        <span class="c1"># &#39;&#39;&#39;Private method.</span>
        <span class="c1"># Tells if the address given is from this host.</span>
        <span class="c1">#</span>
        <span class="c1"># :param ParseResult aurl: address to analyze.</span>
        <span class="c1"># :return: (*Bool.*) If is local (**True**) or not (**False**).</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_url</span><span class="o">.</span><span class="n">netloc</span> <span class="o">==</span> <span class="n">aurl</span><span class="o">.</span><span class="n">netloc</span>


    <span class="k">def</span> <span class="nf">launch_actor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span><span class="n">actor</span><span class="p">):</span>
        <span class="c1"># &#39;&#39;&#39;Private method.</span>
        <span class="c1"># This function makes an actor alive to start processing queries.</span>
        <span class="c1">#</span>
        <span class="c1"># :param str. url: identifier of the actor.</span>
        <span class="c1"># :param Actor actor: instance of the actor.</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="n">actor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">actor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">actor</span><span class="o">.</span><span class="n">thread</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>


    <span class="k">def</span> <span class="nf">init_host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This method creates an actor for the Host so it can spawn actors remotely.</span>
<span class="sd">        Called always from the init function of the host, so no need for calling</span>
<span class="sd">        this directly.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span>  <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">Actor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="n">Host</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span> <span class="o">=</span> <span class="n">Proxy</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">launch_actor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="n">host</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>



    <span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This gets the signal of Ctrl+C and stops the host. It also ends the execution.</span>
<span class="sd">        Needs the invocation of :meth:`serve_forever`.</span>

<span class="sd">        :param signal: SIGINT signal interruption sent with a Ctrl+C.</span>
<span class="sd">        :param frame: the current stack frame. (not used)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span> <span class="s1">&#39;You pressed Ctrl+C!&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serving</span> <span class="o">=</span> <span class="kc">False</span>


    <span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This allows the host to keep alive indefinitely so its actors can receive</span>
<span class="sd">        queries at any time.</span>
<span class="sd">        To kill the execution, press Ctrl+C.</span>

<span class="sd">        See usage example in :ref:`sample6`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This host is already shutted down.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serving</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_handler</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;Press Ctrl+C to kill the execution&#39;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">serving</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="nb">print</span> <span class="s1">&#39;BYE!&#39;</span>

    <span class="k">def</span> <span class="nf">attach_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_id</span><span class="p">,</span> <span class="n">interval_event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Registers an interval event to the host.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intervals</span><span class="p">[</span><span class="n">interval_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">interval_event</span>
    <span class="k">def</span> <span class="nf">detach_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Deletes an interval event from the host registry.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">intervals</span><span class="p">[</span><span class="n">interval_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks the parameters generating new proxy instances to avoid query</span>
<span class="sd">        concurrences from shared proxies.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Proxy</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">actor</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dumps</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">param</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">new_dict</span><span class="o">=</span><span class="n">param</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dumps</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">new_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param</span>


    <span class="k">def</span> <span class="nf">_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks the return parameters generating new proxy instances to avoid query</span>
<span class="sd">        concurrences from shared proxies.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_url</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_loads</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">param</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">new_dict</span><span class="o">=</span><span class="n">param</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loads</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">new_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param</span>

    <span class="k">def</span> <span class="nf">new_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_url</span><span class="p">,</span> <span class="n">pthr</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Register a new thread executing a parallel method.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pthreads</span><span class="p">[</span><span class="n">pthr</span><span class="p">]</span><span class="o">=</span><span class="n">from_url</span>

    <span class="k">def</span> <span class="nf">del_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pthr</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Deletes a thread executing a parallel method.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pthreads</span><span class="p">[</span><span class="n">pthr</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="intervals">
<span id="intervals-source"></span><h2>Intervals<a class="headerlink" href="#intervals" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Timer</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">currentThread</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">timep</span>

<span class="k">def</span> <span class="nf">later</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sets a timer that will call the *f* function past *timeout* seconds.</span>
<span class="sd">    See example in :ref:`sample_inter`</span>

<span class="sd">    :return: :class:`Timer`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">t</span>


<span class="k">def</span> <span class="nf">interval_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Creates an Event attached to the *host* that will execute the *f* function</span>
<span class="sd">    every *time* seconds.</span>

<span class="sd">    See example in :ref:`sample_inter`</span>

<span class="sd">    :param Proxy host: proxy of the host. Can be obtained from inside a class</span>
<span class="sd">        with ``self.host``.</span>
<span class="sd">    :param int time: seconds for the intervals.</span>
<span class="sd">    :param func f: function to be called every *time* seconds.</span>
<span class="sd">    :param list args: arguments for *f*.</span>
<span class="sd">    :return: :class:`Event` instance of the interval.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">currentThread</span><span class="p">()</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">stop_event</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">stop_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">host</span><span class="o">.</span><span class="n">detach_interval</span><span class="p">(</span><span class="n">thread_id</span><span class="p">)</span>
    <span class="n">t2_stop</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t2_stop</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">wrap</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">thread_id</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
    <span class="n">host</span><span class="o">.</span><span class="n">attach_interval</span><span class="p">(</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">t2_stop</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t2_stop</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="parallel">
<span id="parallels-source"></span><h2>Parallel<a class="headerlink" href="#parallel" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyactor.actor</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyactor.intervals</span> <span class="k">import</span> <span class="n">interval_host</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Lock</span>

<span class="n">CLEAN_INT</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">class</span> <span class="nc">ActorParallel</span><span class="p">(</span><span class="n">Actor</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Actor with parallel methods. Parallel methods are invoked in new threads, so</span>
<span class="sd">    their invocation do not block the actor allowing it to process many queries</span>
<span class="sd">    at a time.</span>
<span class="sd">    To aboid concurrence problems, this actors use Locks to guarantee its correct</span>
<span class="sd">    state.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ActorParallel</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">klass</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pthreads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ask_parallel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">)</span><span class="o">|</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ask_ref</span><span class="p">))</span><span class="o">&amp;</span><span class="nb">set</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">_parallel</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tell_parallel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tell</span><span class="p">)</span><span class="o">|</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tell_ref</span><span class="p">))</span><span class="o">&amp;</span><span class="nb">set</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">_parallel</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_parallel</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">ParallelAskWraper</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">method</span><span class="p">),</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tell_parallel</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">ParallelTellWraper</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">method</span><span class="p">),</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cleaner</span> <span class="o">=</span> <span class="n">interval_host</span><span class="p">(</span><span class="n">get_host</span><span class="p">(),</span> <span class="n">CLEAN_INT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_clean</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Overwriting :meth:`Actor.receive`, adds the checks and functionalities</span>
<span class="sd">        requiered by parallel methods.</span>

<span class="sd">        :param msg: The message is a namedtuple of the defined in util.py</span>
<span class="sd">            (:class:`~.AskRequest`, :class:`~.TellRequest`, :class:`~.FutureRequest`).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">method</span><span class="o">==</span><span class="s1">&#39;stop&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleaner</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pthreads</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">invoke</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">params</span>

                <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_parallel</span><span class="p">:</span>
                    <span class="n">rpc_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
                    <span class="c1"># add rpc message to pendent AskResponse s</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">[</span><span class="n">rpc_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>
                    <span class="c1"># insert an rpc id to args</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rpc_id</span><span class="p">)</span>
                    <span class="n">invoke</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">invoke</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">e</span>
                <span class="nb">print</span> <span class="n">result</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">receive_from_ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">rpc_id</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">[</span><span class="n">rpc_id</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">[</span><span class="n">rpc_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">get_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :return: :class:`Lock` of the actor.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span>

    <span class="k">def</span> <span class="nf">do_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This function is called at intervals to delete the threads created for</span>
<span class="sd">        parallel methods that have already stopped.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pthreads</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                <span class="n">get_host</span><span class="p">()</span><span class="o">.</span><span class="n">del_parallel</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pthreads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ParallelAskWraper</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Wrapper for ask methods that have to be called in a parallel form.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__actor</span> <span class="o">=</span> <span class="n">actor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span> <span class="o">=</span> <span class="n">lock</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">rpc_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rpc_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rpc_id</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">invoke</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__method</span><span class="p">,</span><span class="n">rpc_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__actor</span><span class="o">.</span><span class="n">pthreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
                <span class="n">get_host</span><span class="p">()</span><span class="o">.</span><span class="n">new_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__actor</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">rpc_id</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">result</span><span class="o">=</span> <span class="n">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__actor</span><span class="o">.</span><span class="n">receive_from_ask</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">rpc_id</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ParallelTellWraper</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Wrapper for tell methods that have to be called in a parallel form.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__actor</span> <span class="o">=</span> <span class="n">actor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span> <span class="o">=</span> <span class="n">lock</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">invoke</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__actor</span><span class="o">.</span><span class="n">pthreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">get_host</span><span class="p">()</span><span class="o">.</span><span class="n">new_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__actor</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Source</a><ul>
<li><a class="reference internal" href="#actor">Actor</a></li>
<li><a class="reference internal" href="#proxy">Proxy</a></li>
<li><a class="reference internal" href="#context">Context</a></li>
<li><a class="reference internal" href="#intervals">Intervals</a></li>
<li><a class="reference internal" href="#parallel">Parallel</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/source.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">PyActor 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, URV.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.
    </div>
  </body>
</html>